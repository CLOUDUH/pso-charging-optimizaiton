Battery PSO Charging

Initialization
clear
clc

global t_p; global SoC_Grid; global Temp_Grid; global VO_Tab; global R0_Tab; global tau1_Tab; global R1_Tab; 
global Tf;global m; global A; global c; global h; global z; global B; global E_a; global R; global alpha; global Qe;

Temp_Tab = [-10 0 25 40 60];
SoC_Tab = [0.01 : 0.01 : 1];
[Temp_Grid, SoC_Grid] = meshgrid(Temp_Tab, SoC_Tab);
VO_Tab = [2.70384105100118 2.70388161949721 2.81935690339157 2.7391075025538 2.72928387808362;2.76591876677511 2.78384355630075 2.89545260212696 2.8780598120635 2.89802529888853;2.81853453748881 2.85160905597565 2.95184449082619 2.96488827956253 2.9877394151511;2.8633248566495 2.91153058483595 3.00723578658312 3.02802496609568 3.05038290923306;2.89681107388125 2.95948471811946 3.05689652518099 3.06367585483311 3.10321270800539;2.9299736669207 2.99685316756762 3.10435141051919 3.09439727006668 3.12658462543668;2.96277576237455 3.03363912758476 3.14987509957828 3.12819371999361 3.15664585369591;2.99534026159724 3.06899153243354 3.18761695606662 3.16086993327614 3.18615701182384;3.01610832952436 3.09586517089461 3.22269655379693 3.19674428963447 3.21757619277392;3.03633124807349 3.12057181116385 3.25351201160028 3.23583455728532 3.25239774959906;3.05620345061808 3.14453389413466 3.28213726932968 3.27039805765101 3.28837517675625;3.07221854357655 3.16198792888434 3.30653792110743 3.30316872264218 3.32170706115282;3.08762500015484 3.17908942142563 3.32872934500201 3.33439446821022 3.35265585562177;3.10212990015342 3.19645086452981 3.34785312101299 3.3619842812645 3.38059871131583;3.11409741834397 3.21062916082384 3.36550772682007 3.38608814864985 3.40654231535486;3.12652049360494 3.22387802636351 3.38090641305224 3.40632859640336 3.42748632146958;3.13937542222494 3.23536795461148 3.3952614564118 3.42551874739979 3.44767981786941;3.15165945429441 3.24650515789304 3.40792679573927 3.44170085990807 3.46613915770919;3.16354584432302 3.25791424667735 3.41868281971695 3.45567095090667 3.47803365873322;3.17507200056793 3.26877194134654 3.42829825410695 3.4685561784142 3.49021252039374;3.19420745576655 3.28915841286496 3.43635161933948 3.49151232547979 3.51249948703782;3.20450834076201 3.2983045907922 3.44446716486289 3.4996583228323 3.52151726925776;3.21587962403411 3.30727880700263 3.45288948219376 3.50631281859165 3.52874898427997;3.22711089278737 3.31632550554406 3.46128460779894 3.51391375875558 3.53675408669143;3.23682367671771 3.32562349377916 3.46884549623115 3.52224049835006 3.5457000681481;3.24608909671007 3.33518494912156 3.47645306921898 3.52992069528996 3.55415775110009;3.25520815108051 3.3449391680389 3.4841371932503 3.53613884360839 3.56164311959509;3.26427519645418 3.35468668824764 3.49175638218446 3.54122265374486 3.56601677443959;3.2733078980036 3.36418083901852 3.49944460007375 3.54558567333136 3.56998862389657;3.28270974366837 3.37264923049695 3.50723061035573 3.55130147404126 3.57571065809771;3.2922587392151 3.38003958742994 3.51453570226077 3.55784356888064 3.58287814115146;3.30171391756135 3.38768081084926 3.52170629788128 3.56522023338534 3.59021566254165;3.31117445504095 3.39591772015111 3.52881481842512 3.57211394754329 3.5960079909296;3.3199596661104 3.40409564980206 3.53588463113105 3.57773360021364 3.601482540154;3.32871810330858 3.41227405637702 3.54282567399268 3.58318635944972 3.60702880668709;3.33726632580452 3.42081523840153 3.5497454894816 3.58793755986951 3.61269271343447;3.34546851813882 3.42944007284677 3.55643293248504 3.59284011797383 3.61872007704694;3.35335980862788 3.43768103897646 3.56288994079734 3.59781085231034 3.62511092321923;3.36124554230914 3.44488839940882 3.56946850567913 3.60283710967997 3.63138704586789;3.3691057028546 3.45208760121429 3.5759764402418 3.60950172744304 3.63777973286492;3.37701339738317 3.45963828782747 3.5818871213477 3.61633835142032 3.64438256344913;3.38523585254859 3.46717213994272 3.58781637995015 3.62172029193992 3.65057293827494;3.39348068163542 3.47379683895376 3.59378225959152 3.62650649639597 3.6558854557601;3.40181808295318 3.48030178848888 3.59971264712514 3.6316564981289 3.66101566331055;3.41041707847046 3.4872685021179 3.60569516582689 3.63818658756404 3.6658846195054;3.41875225381431 3.49443695050233 3.61192929886304 3.64470948388668 3.67073117658878;3.42664207522794 3.50218400951375 3.61880272622746 3.65127448692151 3.67734383931452;3.43463371152196 3.51038804161453 3.62563683399603 3.65774894347684 3.68460053483688;3.44275416480509 3.51874121244066 3.63236412758089 3.66419927102635 3.69114466597371;3.45082533962034 3.52648757006741 3.63931121993011 3.67089322659812 3.69700186520305;3.45847308825065 3.53441479940595 3.64640954031599 3.67852485414744 3.70320854748565;3.46595365425732 3.54258127308306 3.65347877777707 3.68663759064984 3.71008613624675;3.47340612008181 3.55132460365864 3.66077627403978 3.6945765103119 3.71739292125295;3.48067641862604 3.56001077241296 3.66806621147446 3.70221467246264 3.72485404619462;3.48825752147064 3.568228965705 3.67527857807175 3.710981609738 3.73300459873639;3.4960619499269 3.57583509864181 3.68249094466904 3.72004283529237 3.74113397326007;3.50401975028594 3.58331549693039 3.6902977335222 3.72793814666577 3.74909604925609;3.51304896657549 3.59092984133606 3.69897716080666 3.7353105428712 3.75697465085424;3.52217043680682 3.59892751911497 3.70775113384052 3.74336539496249 3.76466733060136;3.53129679720095 3.60746052224022 3.7166751774088 3.75211003566947 3.77296797924441;3.53952919833089 3.61719258740164 3.72511990620198 3.76082069327072 3.78143310274007;3.54723984738681 3.6268839646553 3.73354500687059 3.76938726304317 3.78953845180378;3.55485825027012 3.634470877046 3.741977810941 3.77801429180493 3.79772229984098;3.56252739363208 3.64131668948123 3.75026429183835 3.78644704110974 3.80617099836755;3.56999707320173 3.64819981488614 3.75831590237164 3.79489190379625 3.81548868771748;3.5766629077409 3.65567693475816 3.76636751290492 3.80316259487983 3.82452427774537;3.58318017618633 3.66327129985572 3.77438409984529 3.81238407815662 3.83273837342158;3.58958530837707 3.67056634886747 3.78200337747082 3.82189815464489 3.84078030980837;3.5963286791069 3.6772102536093 3.78947696765021 3.8288725213027 3.84902258600854;3.60349892262189 3.68422527739916 3.79663768102906 3.83543205802603 3.85672075343237;3.6096974182635 3.6907824246798 3.80384869604951 3.84230948818884 3.86382532653751;3.61485292475026 3.69698410561938 3.81145094198494 3.85007654674517 3.87131919888278;3.61942533286226 3.70305813255689 3.81905290578371 3.85846327474325 3.87937328203038;3.62380017850345 3.7085112022807 3.8265115741043 3.86710857589067 3.88681177618377;3.62826986602246 3.71378161674077 3.83328917558414 3.8748153757152 3.89404025427904;3.63216060964573 3.71920664263397 3.8398656899501 3.88001554323031 3.90061084466643;3.63601161495683 3.72440121006266 3.84659881911148 3.88513507744419 3.90711969530987;3.63990754619668 3.72967429501632 3.85345548933313 3.89266593517503 3.91381901572012;3.64297716641562 3.73496359761975 3.86045841780059 3.90037217296929 3.9205407119703;3.64579084909273 3.73995233001163 3.86746134626804 3.90765669635661 3.9273192712984;3.64927418133245 3.74557118162299 3.8745417927969 3.91474464323635 3.9344455850591;3.65309727971421 3.75153906945327 3.88252111614212 3.92247743374602 3.94248254300815;3.65715830106953 3.75751172744709 3.89059154707163 3.93104360682092 3.95143369213076;3.66073364147055 3.76298139292015 3.89866930768563 3.94091386980127 3.96092966654562;3.66288636417701 3.76857109351173 3.90787486712212 3.95219402327529 3.97165712446117;3.66303669434214 3.77338010537907 3.9178551620464 3.96341064406478 3.98224081302326;3.6631860957581 3.77826465568975 3.92813705428658 3.97351704457392 3.99352462115244;3.66289058514062 3.78314029566924 3.93836260698718 3.98401230668235 4.00498819489842;3.66199876999011 3.78753146926728 3.94850710778815 3.99607490839653 4.01615204950356;3.66079143257718 3.79147524456833 3.95834573186859 4.00775394304332 4.02751738483541;3.65906120605507 3.79509220542903 3.96846145663315 4.01921415297966 4.03930430214824;3.65659790051668 3.79738367254969 3.9787062549329 4.03097366050933 4.05200175600684;3.65097976514358 3.79960337484066 3.98909220063795 4.04136178745653 4.06381807513738;3.64541899880145 3.80206646712266 3.99929132497086 4.05294300662754 4.07600664611418;3.63541440906505 3.80314946092182 4.00918348049393 4.06428442885126 4.08781799966186;3.62267993093031 3.80266344060667 4.01784807875741 4.07285705242413 4.09691111135763;3.60705564846773 3.80070592385927 4.02585029629506 4.07947456147966 4.10252755492283;3.5897893661027 3.79888279469096 4.03364865670183 4.08597245585193 4.108422573301;3.57412066270312 3.79391637336835 4.04071331633849 4.08939718268066 4.1104205279257;3.5690784312267 3.79927795854429 4.05000235306432 4.09320231109632 4.11253819742874];
R0_Tab = [0.0623201560809008 0.0616346719974068 0.0672232471172425 0.0702157821887717 0.0677806380398742;0.0640696468145929 0.0632871365456733 0.0675048570049006 0.0737777618080688 0.0719712615428953;0.0655744675779246 0.0651567784472622 0.0658324829459229 0.0760035703081048 0.0741992745723525;0.0669280337324434 0.0670624631561747 0.066618442797761 0.0776220507166308 0.0757549998789102;0.0679149120055698 0.0685423019836353 0.0673607505034961 0.0750341442088054 0.077067006115076;0.0687850243882941 0.0697156999285315 0.0688215675052961 0.0718796036036995 0.0736430294132777;0.0695605184061669 0.0709123059255727 0.0706749441027854 0.0717004642852004 0.0726178355774323;0.0702149364662912 0.0719570982291255 0.0721974749131173 0.0718363081225206 0.0725221645726961;0.0705045613539781 0.0726827550819138 0.0732851891643134 0.0727846895068751 0.0731573046864185;0.0706460190995504 0.0732547167650299 0.0744948954523228 0.0742931152045632 0.0744887461900152;0.0708505181804746 0.0736862276084693 0.0755560187357567 0.07566506990233 0.0759792817675482;0.0707651720405789 0.073854807821963 0.0762706114673195 0.0767359842068025 0.0770440987004406;0.0705053964950544 0.0739130201371392 0.0769110634738004 0.0778871875795559 0.0782200768990737;0.0700708742932719 0.0739938992718496 0.0772183262516579 0.0788117264136066 0.0792064614702355;0.0694850507820899 0.0737950229130622 0.0774615762785944 0.0794946907024734 0.0799609351188675;0.0690082974357882 0.0733987385139336 0.0774979055593534 0.0799590313305494 0.0804875516524355;0.0686814765885906 0.0728005669275671 0.0774979463260581 0.0802487157578646 0.0808275652452242;0.0683843765593508 0.0721199745601293 0.0772711896445128 0.0803196474361609 0.0810002828919316;0.0679903623112086 0.0716245853415476 0.0768163056518834 0.0802698089364213 0.0808728097090778;0.0675102408269233 0.0712668969067032 0.076173399066362 0.0801235261500608 0.0807710733730769;0.066574121592859 0.0703277749378182 0.0753334091989142 0.0790739163570646 0.0797383867645816;0.0661759208549766 0.0697845559443344 0.0746676403293891 0.0784135948473117 0.0791340608971249;0.065861164402238 0.0692510842567882 0.07419423292863 0.0775507758697036 0.0783121842194379;0.0655652813873795 0.0687567248042367 0.0737087623116819 0.0767593919887744 0.0774730338785936;0.0652504145371346 0.0683416554988834 0.0730695416171001 0.0761808657287291 0.0768538197421065;0.0649214743083886 0.0679683149804111 0.0724595945046094 0.0756487016890781 0.0763345284630268;0.0646581021418795 0.0676162559333995 0.0718976487755669 0.0749717212470373 0.0757129643808989;0.0643854569279791 0.0672640016889923 0.0714057975046813 0.0742449763149775 0.0749552388624113;0.0641053792658868 0.0669550275509789 0.0709421521949056 0.0735486921423263 0.0742312308707374;0.0638412881072767 0.0666432965979356 0.0704976851058421 0.0729688524667056 0.0736222411048884;0.063583921521809 0.0663022397837567 0.0700466957470027 0.0724538409034108 0.0731058165453464;0.063316506448297 0.0659713920134459 0.0696820165717305 0.0719778721703541 0.0726182475223567;0.0630373546955743 0.06565950790463 0.0693051637550495 0.0714907142749976 0.0721034566838816;0.0627487920843697 0.0653406217797206 0.0689207198830906 0.0710555868282801 0.0716412815163698;0.062464248207069 0.0650089883318832 0.0685437517640675 0.0706149700608281 0.0711993188237003;0.0621355732792823 0.0646853656836428 0.0681680160034006 0.0701534136962447 0.070751395563398;0.061735928342773 0.0643704803685594 0.0677754253366238 0.0697120035519658 0.0703226464767166;0.0613302291503355 0.0640066501048464 0.0673628125396613 0.0692745488469382 0.069907116415616;0.0609254057018616 0.0635540149274192 0.0669728148141056 0.0688231456060513 0.0694768093664502;0.0605158084440296 0.0631014991757186 0.0665689656650186 0.0683939516672418 0.0690348823825451;0.060131857054603 0.062656058904675 0.0660465386969782 0.067986601158688 0.0686171841296281;0.059809727643771 0.062209929753092 0.0655248428764135 0.0675205313798624 0.0681806917803138;0.0595382897241317 0.0617791599670583 0.0650071883544761 0.0669484102027336 0.0676120184854265;0.0592761992335316 0.0614047839234866 0.0644825734191863 0.0663843415412679 0.0670392319991202;0.0590274450586232 0.061091077368927 0.0639906473680232 0.0658467961477229 0.0664652013427229;0.0588003186940393 0.0607851587081503 0.063572955173862 0.0653135445228075 0.0658889900633506;0.0585904384170712 0.0605007262731694 0.0632330948546689 0.0648262066585774 0.0653842273922427;0.0583925004484893 0.0602598086714261 0.0628955172406047 0.0644070949687667 0.0649622126775915;0.0582157001480326 0.0600454856791188 0.0625641407402542 0.0640318732784593 0.0645825030394067;0.0580246127679374 0.0598248246429134 0.0622748539936833 0.0636696866470299 0.0641984058886167;0.0577487499018607 0.0596412447461434 0.0620141168135926 0.0633498355023088 0.0638426648249779;0.057408480096814 0.0593985746337591 0.061755068047133 0.063074367757078 0.0635374150928314;0.0570778611091294 0.059072924709525 0.0615407834750767 0.0628125076762758 0.0632603456486667;0.0567900601197855 0.0587252990125608 0.0612375941094663 0.062570612058535 0.0630053003050453;0.0565418706138221 0.0584087125488093 0.0608257578830669 0.0623164650735224 0.0627504616755137;0.0563441511018894 0.0581235835183507 0.0604139216566675 0.0619610710806868 0.0623907795843932;0.0562263204951741 0.0578826668183763 0.0600757901015352 0.0615408248661002 0.0619666259742742;0.05615847726704 0.0577129396142064 0.0598048353224718 0.0611519506259892 0.0615729362525101;0.0560933004359514 0.0576032321544329 0.0595931655193365 0.0608251082580669 0.0612301336700072;0.0560308732708927 0.0575171399191881 0.0594747546561787 0.0605654055701148 0.060951791255087;0.0559832769477415 0.0574512156287845 0.0593705357290042 0.0603912072460111 0.0607588489011217;0.0559180796724332 0.0574057152365959 0.0592639685148764 0.0602706190016442 0.0606233845908735;0.0558390767031876 0.0573356026641112 0.0591622317240468 0.0601587402068726 0.060502509256688;0.0557626014052643 0.0572330121750015 0.0591087281876459 0.0600473911012669 0.0603887149019413;0.0556724009359923 0.0571323802802066 0.0590158645000112 0.0599780444362756 0.0603258867171017;0.0555441562797214 0.0570343522284369 0.0589230008123773 0.0598771671391032 0.0602395009349381;0.0553871624721918 0.0569096112735199 0.058832170424767 0.0597869637767605 0.0601313786468571;0.0552116342165307 0.0567523052810692 0.0586970044331072 0.0597053365738787 0.0600242785140659;0.0550971988103908 0.0565634285040186 0.0585332674460957 0.0595495105496102 0.0598899644417621;0.0550571736034793 0.0564415706183592 0.0583219552747432 0.0593569953416968 0.0597170138570005;0.0550022661833012 0.0563836549211572 0.0581736500520482 0.059129704382098 0.0594879428597439;0.0549135856817156 0.056319026768255 0.0581164514624111 0.0589882493049636 0.0593299380479455;0.0547089743353615 0.0562310093194713 0.0580592099718493 0.0589395579517582 0.0592746026555453;0.0544639731953613 0.0560144817251333 0.0579801793656429 0.0588912575959268 0.0592081819298089;0.0542661304611971 0.0557602328853131 0.0577629792459664 0.0587843072478749 0.059103459757174;0.0540980508179287 0.0555735773780563 0.0575057864035937 0.0585194994385527 0.0588596345937011;0.0539547112395202 0.0554193926626385 0.0573256549046124 0.0582422773290463 0.0585943124011332;0.0538209800925342 0.0552917308129888 0.0571849274436844 0.0580699955726041 0.0584041445192582;0.0536842053494095 0.0551675473312452 0.057072882918535 0.0579377327016295 0.0582531053612265;0.0536419789273808 0.0550543366188587 0.0569608383933864 0.0578186932640432 0.0581246587384201;0.0537477607700647 0.0551241871273205 0.0568687709576299 0.0577046904597798 0.0580080316629874;0.0538892663652311 0.0552887293773225 0.0570227537217245 0.0577137931149601 0.0580054543848987;0.0540477710373906 0.0554667059619587 0.0572338655579925 0.0579091976584727 0.0582037948548546;0.0542608359465206 0.0556834237269732 0.0574445518683109 0.0581558576680536 0.0584458339399032;0.0545069719295541 0.0559669993119072 0.057765035270906 0.0584625424024567 0.0587413140891035;0.054741170405038 0.0562763773555583 0.0581613126557157 0.0588480012902894 0.0591155473732017;0.0549685731342335 0.0565921998186756 0.0585824382957547 0.0592657355264494 0.0595518783025022;0.055176556912464 0.0568978282894643 0.0589958029472859 0.0596960698138056 0.0599992825628419;0.0552399257123466 0.0571123175516779 0.0593929887701221 0.0601378484631456 0.0604303578152998;0.0552819977911079 0.0572329976027568 0.0596006861919287 0.0604469099108047 0.0607427357108037;0.0553092667950636 0.0573490212600873 0.0598278848151796 0.0606917131170026 0.0609927099233238;0.0553381624227862 0.0574464272032933 0.0600487877897482 0.0609343953783159 0.0612505452587451;0.0553382039685824 0.0575663944012361 0.0603012894170503 0.0611749147165535 0.0615125239016003;0.0552793888934402 0.057664516437439 0.0605656479847876 0.0614585741323421 0.0618058050424737;0.0549377728712663 0.0575501159362419 0.0606641225768132 0.0616136282571342 0.0619713661440415;0.054218869523516 0.0570426017795271 0.0603378675344333 0.0613400299141635 0.061709877201102;0.0531790522621836 0.0561525559362375 0.0595396392305343 0.0605444587911155 0.0608988020450711;0.0517978998615183 0.0550207458148804 0.0586018597697726 0.0595520459963943 0.0598897013615702;0.0494598182362327 0.0526784567934593 0.0562570499398802 0.05717071379412 0.0574807708499079;0.0467764144940035 0.0498816684474868 0.0532149323073901 0.0539573434935474 0.0542226562838142];
R1_Tab = [0.0871200000000000	0.0833257142857143	0.0738400000000000	0.0480057142857143	0.0135600000000000;0.0852400000000000	0.0813657142857143	0.0716800000000000	0.0482971428571429	0.0171200000000000;0.0833600000000000	0.0794057142857143	0.0695200000000000	0.0485885714285714	0.0206800000000000;0.0814800000000000	0.0774457142857143	0.0673600000000000	0.0488800000000000	0.0242400000000000;0.0796000000000000	0.0754857142857143	0.0652000000000000	0.0491714285714286	0.0278000000000000;0.0777200000000000	0.0735257142857143	0.0630400000000000	0.0494628571428571	0.0313600000000000;0.0758400000000000	0.0715657142857143	0.0608800000000000	0.0497542857142857	0.0349200000000000;0.0739600000000000	0.0696057142857143	0.0587200000000000	0.0500457142857143	0.0384800000000000;0.0720800000000000	0.0676457142857143	0.0565600000000000	0.0503371428571429	0.0420400000000000;0.0702000000000000	0.0656857142857143	0.0544000000000000	0.0506285714285714	0.0456000000000000;0.0683200000000000	0.0637257142857143	0.0522400000000000	0.0509200000000000	0.0491600000000000;0.0664400000000000	0.0617657142857143	0.0500800000000000	0.0512114285714286	0.0527200000000000;0.0645600000000000	0.0598057142857143	0.0479200000000000	0.0515028571428571	0.0562800000000000;0.0626800000000000	0.0578457142857143	0.0457600000000000	0.0517942857142857	0.0598400000000000;0.0608000000000000	0.0558857142857143	0.0436000000000000	0.0520857142857143	0.0634000000000000;0.0589200000000000	0.0539257142857143	0.0414400000000000	0.0523771428571429	0.0669600000000000;0.0570400000000000	0.0519657142857143	0.0392800000000000	0.0526685714285714	0.0705200000000000;0.0551600000000000	0.0500057142857143	0.0371200000000000	0.0529600000000000	0.0740800000000000;0.0532800000000000	0.0480457142857143	0.0349600000000000	0.0532514285714286	0.0776400000000000;0.0514000000000000	0.0460857142857143	0.0328000000000000	0.0535428571428571	0.0812000000000000;0.0495200000000000	0.0441257142857143	0.0306400000000000	0.0538342857142857	0.0847600000000000;0.0476400000000000	0.0421657142857143	0.0284800000000000	0.0541257142857143	0.0883200000000000;0.0457600000000000	0.0402057142857143	0.0263200000000000	0.0544171428571429	0.0918800000000000;0.0438800000000000	0.0382457142857143	0.0241600000000000	0.0547085714285714	0.0954400000000000;0.0420000000000000	0.0362857142857143	0.0220000000000000	0.0550000000000000	0.0990000000000000;0.0410800000000000	0.0354571428571429	0.0214000000000000	0.0529942857142857	0.0951200000000000;0.0401600000000000	0.0346285714285714	0.0208000000000000	0.0509885714285714	0.0912400000000000;0.0392400000000000	0.0338000000000000	0.0202000000000000	0.0489828571428571	0.0873600000000000;0.0383200000000000	0.0329714285714286	0.0196000000000000	0.0469771428571428	0.0834800000000000;0.0374000000000000	0.0321428571428572	0.0190000000000000	0.0449714285714286	0.0796000000000000;0.0364800000000000	0.0313142857142857	0.0184000000000000	0.0429657142857143	0.0757200000000000;0.0355600000000000	0.0304857142857143	0.0178000000000000	0.0409600000000000	0.0718400000000000;0.0346400000000000	0.0296571428571429	0.0172000000000000	0.0389542857142857	0.0679600000000000;0.0337200000000000	0.0288285714285714	0.0166000000000000	0.0369485714285714	0.0640800000000000;0.0328000000000000	0.0280000000000000	0.0160000000000000	0.0349428571428571	0.0602000000000000;0.0318800000000000	0.0271714285714286	0.0154000000000000	0.0329371428571428	0.0563200000000000;0.0309600000000000	0.0263428571428571	0.0148000000000000	0.0309314285714286	0.0524400000000000;0.0300400000000000	0.0255142857142857	0.0142000000000000	0.0289257142857143	0.0485600000000000;0.0291200000000000	0.0246857142857143	0.0136000000000000	0.0269200000000000	0.0446800000000000;0.0282000000000000	0.0238571428571429	0.0130000000000000	0.0249142857142857	0.0408000000000000;0.0272800000000000	0.0230285714285714	0.0124000000000000	0.0229085714285714	0.0369200000000000;0.0263600000000000	0.0222000000000000	0.0118000000000000	0.0209028571428571	0.0330400000000000;0.0254400000000000	0.0213714285714286	0.0112000000000000	0.0188971428571429	0.0291600000000000;0.0245200000000000	0.0205428571428571	0.0106000000000000	0.0168914285714286	0.0252800000000000;0.0236000000000000	0.0197142857142857	0.0100000000000000	0.0148857142857143	0.0214000000000000;0.0226800000000000	0.0188857142857143	0.00940000000000000	0.0128800000000000	0.0175200000000000;0.0217600000000000	0.0180571428571429	0.00880000000000000	0.0108742857142857	0.0136400000000000;0.0208400000000000	0.0172285714285714	0.00820000000000000	0.00886857142857142	0.00975999999999999;0.0199200000000000	0.0164000000000000	0.00760000000000000	0.00686285714285714	0.00588000000000000;0.0190000000000000	0.0155714285714286	0.00700000000000000	0.00485714285714286	0.00200000000000000;0.0196400000000000	0.0162342857142857	0.00772000000000000	0.00550000000000000	0.00254000000000000;0.0202800000000000	0.0168971428571429	0.00844000000000000	0.00614285714285714	0.00308000000000000;0.0209200000000000	0.0175600000000000	0.00916000000000000	0.00678571428571429	0.00362000000000000;0.0215600000000000	0.0182228571428571	0.00988000000000000	0.00742857142857143	0.00416000000000000;0.0222000000000000	0.0188857142857143	0.0106000000000000	0.00807142857142857	0.00470000000000000;0.0228400000000000	0.0195485714285714	0.0113200000000000	0.00871428571428572	0.00524000000000000;0.0234800000000000	0.0202114285714286	0.0120400000000000	0.00935714285714286	0.00578000000000000;0.0241200000000000	0.0208742857142857	0.0127600000000000	0.0100000000000000	0.00632000000000000;0.0247600000000000	0.0215371428571429	0.0134800000000000	0.0106428571428571	0.00686000000000000;0.0254000000000000	0.0222000000000000	0.0142000000000000	0.0112857142857143	0.00740000000000000;0.0260400000000000	0.0228628571428571	0.0149200000000000	0.0119285714285714	0.00794000000000000;0.0266800000000000	0.0235257142857143	0.0156400000000000	0.0125714285714286	0.00848000000000000;0.0273200000000000	0.0241885714285714	0.0163600000000000	0.0132142857142857	0.00902000000000000;0.0279600000000000	0.0248514285714286	0.0170800000000000	0.0138571428571429	0.00956000000000000;0.0286000000000000	0.0255142857142857	0.0178000000000000	0.0145000000000000	0.0101000000000000;0.0292400000000000	0.0261771428571429	0.0185200000000000	0.0151428571428571	0.0106400000000000;0.0298800000000000	0.0268400000000000	0.0192400000000000	0.0157857142857143	0.0111800000000000;0.0305200000000000	0.0275028571428571	0.0199600000000000	0.0164285714285714	0.0117200000000000;0.0311600000000000	0.0281657142857143	0.0206800000000000	0.0170714285714286	0.0122600000000000;0.0318000000000000	0.0288285714285714	0.0214000000000000	0.0177142857142857	0.0128000000000000;0.0324400000000000	0.0294914285714286	0.0221200000000000	0.0183571428571429	0.0133400000000000;0.0330800000000000	0.0301542857142857	0.0228400000000000	0.0190000000000000	0.0138800000000000;0.0337200000000000	0.0308171428571429	0.0235600000000000	0.0196428571428571	0.0144200000000000;0.0343600000000000	0.0314800000000000	0.0242800000000000	0.0202857142857143	0.0149600000000000;0.0350000000000000	0.0321428571428571	0.0250000000000000	0.0209285714285714	0.0155000000000000;0.0356400000000000	0.0328057142857143	0.0257200000000000	0.0215714285714286	0.0160400000000000;0.0362800000000000	0.0334685714285714	0.0264400000000000	0.0222142857142857	0.0165800000000000;0.0369200000000000	0.0341314285714286	0.0271600000000000	0.0228571428571429	0.0171200000000000;0.0375600000000000	0.0347942857142857	0.0278800000000000	0.0235000000000000	0.0176600000000000;0.0382000000000000	0.0354571428571429	0.0286000000000000	0.0241428571428571	0.0182000000000000;0.0388400000000000	0.0361200000000000	0.0293200000000000	0.0247857142857143	0.0187400000000000;0.0394800000000000	0.0367828571428571	0.0300400000000000	0.0254285714285714	0.0192800000000000;0.0401200000000000	0.0374457142857143	0.0307600000000000	0.0260714285714286	0.0198200000000000;0.0407600000000000	0.0381085714285714	0.0314800000000000	0.0267142857142857	0.0203600000000000;0.0414000000000000	0.0387714285714286	0.0322000000000000	0.0273571428571429	0.0209000000000000;0.0420400000000000	0.0394342857142857	0.0329200000000000	0.0280000000000000	0.0214400000000000;0.0426800000000000	0.0400971428571429	0.0336400000000000	0.0286428571428571	0.0219800000000000;0.0433200000000000	0.0407600000000000	0.0343600000000000	0.0292857142857143	0.0225200000000000;0.0439600000000000	0.0414228571428571	0.0350800000000000	0.0299285714285714	0.0230600000000000;0.0446000000000000	0.0420857142857143	0.0358000000000000	0.0305714285714286	0.0236000000000000;0.0452400000000000	0.0427485714285714	0.0365200000000000	0.0312142857142857	0.0241400000000000;0.0458800000000000	0.0434114285714286	0.0372400000000000	0.0318571428571429	0.0246800000000000;0.0465200000000000	0.0440742857142857	0.0379600000000000	0.0325000000000000	0.0252200000000000;0.0471600000000000	0.0447371428571429	0.0386800000000000	0.0331428571428571	0.0257600000000000;0.0478000000000000	0.0454000000000000	0.0394000000000000	0.0337857142857143	0.0263000000000000;0.0484400000000000	0.0460628571428571	0.0401200000000000	0.0344285714285714	0.0268400000000000;0.0490800000000000	0.0467257142857143	0.0408400000000000	0.0350714285714286	0.0273800000000000;0.0497200000000000	0.0473885714285714	0.0415600000000000	0.0357142857142857	0.0279200000000000;0.0503600000000000	0.0480514285714286	0.0422800000000000	0.0363571428571429	0.0284600000000000;0.0510000000000000	0.0487142857142857	0.0430000000000000	0.0370000000000000	0.0290000000000000];
tau1_Tab = [45.9600000000000	74.6800000000000	146.480000000000	197.531428571429	265.600000000000;47.9200000000000	75.6457142857143	144.960000000000	209.777142857143	296.200000000000;49.8800000000000	76.6114285714286	143.440000000000	222.022857142857	326.800000000000;51.8400000000000	77.5771428571429	141.920000000000	234.268571428571	357.400000000000;53.8000000000000	78.5428571428572	140.400000000000	246.514285714286	388;55.7600000000000	79.5085714285714	138.880000000000	258.760000000000	418.600000000000;57.7200000000000	80.4742857142857	137.360000000000	271.005714285714	449.200000000000;59.6800000000000	81.4400000000000	135.840000000000	283.251428571429	479.800000000000;61.6400000000000	82.4057142857143	134.320000000000	295.497142857143	510.400000000000;63.6000000000000	83.3714285714286	132.800000000000	307.742857142857	541;65.5600000000000	84.3371428571429	131.280000000000	319.988571428571	571.600000000000;67.5200000000000	85.3028571428572	129.760000000000	332.234285714286	602.200000000000;69.4800000000000	86.2685714285714	128.240000000000	344.480000000000	632.800000000000;71.4400000000000	87.2342857142857	126.720000000000	356.725714285714	663.400000000000;73.4000000000000	88.2000000000000	125.200000000000	368.971428571429	694.000000000000;75.3600000000000	89.1657142857143	123.680000000000	381.217142857143	724.600000000000;77.3200000000000	90.1314285714286	122.160000000000	393.462857142857	755.200000000000;79.2800000000000	91.0971428571429	120.640000000000	405.708571428571	785.800000000000;81.2400000000000	92.0628571428572	119.120000000000	417.954285714286	816.400000000000;83.2000000000000	93.0285714285714	117.600000000000	430.200000000000	847;85.1600000000000	93.9942857142857	116.080000000000	442.445714285714	877.600000000000;87.1200000000000	94.9600000000000	114.560000000000	454.691428571429	908.200000000000;89.0800000000000	95.9257142857143	113.040000000000	466.937142857143	938.800000000000;91.0400000000000	96.8914285714286	111.520000000000	479.182857142857	969.400000000000;93	97.8571428571429	110	491.428571428571	1000;90.0400000000000	94.7942857142857	106.680000000000	474.668571428571	965.320000000000;87.0800000000000	91.7314285714286	103.360000000000	457.908571428571	930.640000000000;84.1200000000000	88.6685714285714	100.040000000000	441.148571428571	895.960000000000;81.1600000000000	85.6057142857143	96.7200000000000	424.388571428571	861.280000000000;78.2000000000000	82.5428571428571	93.4000000000000	407.628571428571	826.600000000000;75.2400000000000	79.4800000000000	90.0800000000000	390.868571428571	791.920000000000;72.2800000000000	76.4171428571429	86.7600000000000	374.108571428571	757.240000000000;69.3200000000000	73.3542857142857	83.4400000000000	357.348571428571	722.560000000000;66.3600000000000	70.2914285714286	80.1200000000000	340.588571428571	687.880000000000;63.4000000000000	67.2285714285714	76.8000000000000	323.828571428571	653.200000000000;60.4400000000000	64.1657142857143	73.4800000000000	307.068571428571	618.520000000000;57.4800000000000	61.1028571428572	70.1600000000000	290.308571428571	583.840000000000;54.5200000000000	58.0400000000000	66.8400000000000	273.548571428571	549.160000000000;51.5600000000000	54.9771428571429	63.5200000000000	256.788571428571	514.480000000000;48.6000000000000	51.9142857142857	60.2000000000000	240.028571428571	479.800000000000;45.6400000000000	48.8514285714286	56.8800000000000	223.268571428571	445.120000000000;42.6800000000000	45.7885714285714	53.5600000000000	206.508571428571	410.440000000000;39.7200000000000	42.7257142857143	50.2400000000000	189.748571428571	375.760000000000;36.7600000000000	39.6628571428572	46.9200000000000	172.988571428571	341.080000000000;33.8000000000000	36.6000000000000	43.6000000000000	156.228571428571	306.400000000000;30.8400000000000	33.5371428571429	40.2800000000000	139.468571428571	271.720000000000;27.8800000000000	30.4742857142857	36.9600000000000	122.708571428571	237.040000000000;24.9200000000000	27.4114285714286	33.6400000000000	105.948571428571	202.360000000000;21.9600000000000	24.3485714285714	30.3200000000000	89.1885714285715	167.680000000000;19	21.2857142857143	27	72.4285714285714	133;18.6300000000000	20.9928571428571	26.9000000000000	71.2571428571429	130.400000000000;18.2600000000000	20.7000000000000	26.8000000000000	70.0857142857143	127.800000000000;17.8900000000000	20.4071428571429	26.7000000000000	68.9142857142857	125.200000000000;17.5200000000000	20.1142857142857	26.6000000000000	67.7428571428571	122.600000000000;17.1500000000000	19.8214285714286	26.5000000000000	66.5714285714286	120.000000000000;16.7800000000000	19.5285714285714	26.4000000000000	65.4000000000000	117.400000000000;16.4100000000000	19.2357142857143	26.3000000000000	64.2285714285714	114.800000000000;16.0400000000000	18.9428571428571	26.2000000000000	63.0571428571429	112.200000000000;15.6700000000000	18.6500000000000	26.1000000000000	61.8857142857143	109.600000000000;15.3000000000000	18.3571428571429	26	60.7142857142857	107;14.9300000000000	18.0642857142857	25.9000000000000	59.5428571428571	104.400000000000;14.5600000000000	17.7714285714286	25.8000000000000	58.3714285714286	101.800000000000;14.1900000000000	17.4785714285714	25.7000000000000	57.2000000000000	99.2000000000000;13.8200000000000	17.1857142857143	25.6000000000000	56.0285714285714	96.6000000000000;13.4500000000000	16.8928571428571	25.5000000000000	54.8571428571429	94.0000000000000;13.0800000000000	16.6000000000000	25.4000000000000	53.6857142857143	91.4000000000000;12.7100000000000	16.3071428571429	25.3000000000000	52.5142857142857	88.8000000000000;12.3400000000000	16.0142857142857	25.2000000000000	51.3428571428572	86.2000000000000;11.9700000000000	15.7214285714286	25.1000000000000	50.1714285714286	83.6000000000000;11.6000000000000	15.4285714285714	25	49.0000000000000	81.0000000000000;11.2300000000000	15.1357142857143	24.9000000000000	47.8285714285714	78.4000000000000;10.8600000000000	14.8428571428571	24.8000000000000	46.6571428571429	75.8000000000000;10.4900000000000	14.5500000000000	24.7000000000000	45.4857142857143	73.2000000000000;10.1200000000000	14.2571428571429	24.6000000000000	44.3142857142857	70.6000000000000;9.75000000000000	13.9642857142857	24.5000000000000	43.1428571428571	68;9.38000000000000	13.6714285714286	24.4000000000000	41.9714285714286	65.4000000000000;9.01000000000000	13.3785714285714	24.3000000000000	40.8000000000000	62.8000000000000;8.64000000000000	13.0857142857143	24.2000000000000	39.6285714285714	60.2000000000000;8.27000000000000	12.7928571428571	24.1000000000000	38.4571428571429	57.6000000000000;7.90000000000000	12.5000000000000	24	37.2857142857143	55.0000000000000;7.53000000000000	12.2071428571429	23.9000000000000	36.1142857142857	52.4000000000000;7.16000000000000	11.9142857142857	23.8000000000000	34.9428571428571	49.8000000000000;6.79000000000000	11.6214285714286	23.7000000000000	33.7714285714286	47.2000000000000;6.42000000000000	11.3285714285714	23.6000000000000	32.6000000000000	44.6000000000000;6.05000000000000	11.0357142857143	23.5000000000000	31.4285714285714	42.0000000000000;5.68000000000000	10.7428571428571	23.4000000000000	30.2571428571429	39.4000000000000;5.31000000000000	10.4500000000000	23.3000000000000	29.0857142857143	36.8000000000000;4.94000000000000	10.1571428571429	23.2000000000000	27.9142857142857	34.2000000000000;4.57000000000000	9.86428571428571	23.1000000000000	26.7428571428571	31.6000000000000;4.20000000000000	9.57142857142857	23	25.5714285714286	29.0000000000000;3.83000000000000	9.27857142857143	22.9000000000000	24.4000000000000	26.4000000000000;3.46000000000000	8.98571428571428	22.8000000000000	23.2285714285714	23.8000000000000;3.09000000000000	8.69285714285715	22.7000000000000	22.0571428571429	21.2000000000000;2.72000000000000	8.40000000000000	22.6000000000000	20.8857142857143	18.6000000000000;2.35000000000000	8.10714285714286	22.5000000000000	19.7142857142857	16.0000000000000;1.98000000000000	7.81428571428572	22.4000000000000	18.5428571428571	13.4000000000000;1.61000000000000	7.52142857142857	22.3000000000000	17.3714285714286	10.8000000000000;1.24000000000000	7.22857142857143	22.2000000000000	16.2000000000000	8.20000000000001;0.870000000000000	6.93571428571429	22.1000000000000	15.0285714285714	5.60000000000000;0.500000000000000	6.64285714285714	22	13.8571428571429	3];

t_p = 1; % Step
Tf = 298.15; % Homoeothermy
Qe = 3.3; % Battery Capacity Ah
t_m = 2*3600; % Empirical charging time
h = 40.106; % Heat transfer coefficient W/(m^2*K)
c = 800; % Specific heat capacity J/(kg*K)
A = 0.004317; % Heat exchange area at the cell surface m^2
m =0.0475; % Battery mass kg
z = 0.4; % Order of Ah throughput
B = 130; % Pre-exponential factor
E_a = 18461; % Activation energy for cycle aging J/mol
R = 8.314; % Ideal gas constant J/(kg*K)
alpha = 32; % Coefficient for aging acceleration caused by the current

PSO Method
N = 5; % Particle swarm number
d = 5; % Particle dimension
x = zeros(N, d); % Pariticle Position 20-5
v = zeros(N, d); % Pariticle Velcocity 20-5
iter = 1; % Initial iteration
ger = 50; % The maximum number of iterations 
Ilimit = repmat([0; 3.3], 1, d); % Charging current limits 2-5
vlimit = repmat([-0.33; 0.33], 1, d); % Velocity limits 2-5
lsat = zeros(N, d);
hsat = zeros(N, d);
w = 0.729; % inertial weight
c1 = 1.49115; % Self learning factor
c2 = 1.49115; % Swarm learning factor 

beta = 1; % Weight coefficient 1: fastest; 0: healthiest
% f= @(SoH, t)(1 - beta) * (1 - SoH) + beta * t / t_m; % Objective function
f1= @(t)beta * t / t_m; % Objective function

for i = 1:d
    if i == 1
        x(:,i) = repmat(Ilimit(1, i), N, 1) + (Ilimit(2, i) - Ilimit(1, i)) * rand(N, 1); % Initialize CC1 charging current
    else
        x(:,i) = repmat(Ilimit(1, i), N, 1) + (x(i - 1) - Ilimit(1, i)) * rand(N, 1); % Initialize CC2~CC5 charging current
    end
    v(:,i) = repmat(vlimit(1, i), N, 1) + (vlimit(2, i) - vlimit(1, i)) * rand(N, 1); % Initialize velocity
end

x =gpuArray(x);
v =gpuArray(v);

xm = x; % The best known position of particle 20-5
ym = zeros(1, d); % The best known position of entire swarm 1-5
SoH = zeros(ger, N); % SoH of each iteration of each particle 100-20
t = zeros(ger, N); % Charging time of each iteration of each particle 100-20
fx = zeros(ger, N); % Objective function value of each iteration of each particle 100-20
fxm = zeros(N, 1); % Optimal objective function value of particle 20-1
fym = -inf; % Global optimal objective function value

while iter <= ger
    
    for j = 1:N
        [SoH(iter, j), t(iter, j)] = BatChrg(x(j,:)); % Batttery charging
        % fx(iter, j) = f(SoH(iter, j), t(iter,j)) % Optimal function value
        fx(iter, j) = f1(t(iter, j));
        
        if fxm(j) > fx(iter, j)
            fxm(j) = fx(iter, j); % Updating Optimal objective function value of particle
            xm(j,:) = x(j,:); % Updating the best known position of particle
        end
    end
    
    if fym > min(fxm)
        [fym, nmin] = min(fxm); % Updating global optimal objective function value
        ym = xm(nmin, :); % Updating the best known position of entire swarm
    end
    
    v = v * w + c1 * rand * (xm - x) + c2 * rand * (repmat(ym, N, 1) - x); % Updating velocity 
    
    for k = 1:d % Saturation
        v(v(:, k) < vlimit(1, k)) = vlimit(1, k);
        v(v(:, k) > vlimit(2, k)) = vlimit(2, k);
    end
        
    x = x + v; % Updating position
    
    for k = 1:d % Saturation
        x(x(:, k) < Ilimit(1, k)) = Ilimit(1, k);
        x(x(:, k) > Ilimit(2, k)) = Ilimit(2, k);
    end
    
    x

    iter = iter + 1
end

Battery Model Function
function [Vt, SoC] = ECM(I, Temp, SoC)
% Battery 1-RC Equivalent Circuit Model
% Input: 
%   I: Battery current(Charging positive)
%   Temp: Battery temperature
%   SoC: State of Charge
% Output:
%   Vt: Battery Voltage
%   SoC: State of Charge

    global t_p; global SoC_Grid; global Temp_Grid; global VO_Tab; global R0_Tab; global tau1_Tab; global Qe;
    temp = Temp - 273.15;    
    VO = interp2(Temp_Grid, SoC_Grid, VO_Tab, temp, SoC);
    R0 = interp2(Temp_Grid, SoC_Grid, R0_Tab, temp, SoC);
    tau1 = interp2(Temp_Grid, SoC_Grid, tau1_Tab, temp, SoC);
    Vt = VO + I * (1 - exp(t_p / tau1)) + I * R0;
    SoC = SoC + t_p * I / (3600 * Qe);
end

function Temp = ThM(I, Temp, SoC)
% Battery Thermal Model
% Input: 
%   I: Battery current(Charging positive)
%   Temp: Battery temperature
%   SoC: State of Charge
% Output:
%   Temp: Battery temperature

    global t_p; global SoC_Grid; global Temp_Grid; global R0_Tab; global R1_Tab; global Tf;global m; global A; global c; global h; 
    temp = Temp - 273.15; 
    R0 = interp2(Temp_Grid, SoC_Grid, R0_Tab, temp, SoC);
    R1 = interp2(Temp_Grid, SoC_Grid, R1_Tab, temp, SoC);
    dVO_T = (13.02 * SoC^5 - 38.54 * SoC^4 + 32.81 * SoC^3 + 2.042 * SoC^2 - 13.93 * SoC + 4.8) / 1000; 
    dTemp = (I^2 * (R0 + R1) + I * Temp * dVO_T - h * A * (Temp - Tf))/(m * c);
    Temp = Temp + dTemp * t_p;
end

function [Qloss, SoH] = AM(I, Temp, Qloss)
% Battery Aging Model
% Input: 
%   I: Battery current(Charging positive)
%   Temp: Battery temperature
%   Qloss: Loss battery capacity
% Output:
%   Qloss: Loss battery capacity
%   SoH: State of Health

    global t_p; global z; global B; global E_a; global R; global alpha; global Qe;
    dQloss = (abs(I) / 3600) * z * B * exp((-E_a + alpha * abs(I)) / (R * Temp)) * (Qloss / (B * exp ((-E_a + alpha * abs(I)) / (R * Temp))))^(1 - (1 / z));
    Qloss = Qloss + dQloss * t_p;
    SoH = 1 - ((Qloss / Qe) / 0.2);
end

% function [SoH, t, Log] = BatChrg(CC)
function [SoH, t] = BatChrg(CC)
% Battery Charging Function
% Input:
%   CC: Battery charging constant-current(5-1 matrix)
% Output:
%   SoH: Whole charging process SoH
%   t: Charging time cost

    global Qe;
    
    SoC = 0.1; % initial SoC 
    Qloss = 0.0001; % Initial Qloss
    SoH = 1 - ((Qloss / Qe) / 0.2); % Initial SoH
    Temp = 298.15; % Initial Temp
    i = 1; % initial Temp
    
    SoCRange = [0.2 0.4 0.6 0.8 1.0];
    
%     tic
%     [SoC, Qloss, SoH, Temp, i, Log_CC1] = nCC(CC(1), SoC, SoCRange(1), Qloss, SoH, Temp, i);
%     toc
%     tic
%     [SoC, Qloss, SoH, Temp, i, Log_CC2] = nCC(CC(2), SoC, SoCRange(2), Qloss, SoH, Temp, i);
%     toc
%     tic
%     [SoC, Qloss, SoH, Temp, i, Log_CC3] = nCC(CC(3), SoC, SoCRange(3), Qloss, SoH, Temp, i);
%     toc
%     tic
%     [SoC, Qloss, SoH, Temp, i, Log_CC4] = nCC(CC(4), SoC, SoCRange(4), Qloss, SoH, Temp, i);
%     toc
%     tic
%     [SoC, Qloss, SoH, Temp, i, Log_CC5] = nCC(CC(5), SoC, SoCRange(5), Qloss, SoH, Temp, i);
%     toc

    [SoC, Qloss, SoH, Temp, i] = nCC(CC(1), SoC, SoCRange(1), Qloss, SoH, Temp, i);
    [SoC, Qloss, SoH, Temp, i] = nCC(CC(2), SoC, SoCRange(2), Qloss, SoH, Temp, i);
    [SoC, Qloss, SoH, Temp, i] = nCC(CC(3), SoC, SoCRange(3), Qloss, SoH, Temp, i);
    [SoC, Qloss, SoH, Temp, i] = nCC(CC(4), SoC, SoCRange(4), Qloss, SoH, Temp, i);
    [SoC, Qloss, SoH, Temp, i] = nCC(CC(5), SoC, SoCRange(5), Qloss, SoH, Temp, i);
    
    % Log = [Log_CC1; Log_CC2; Log_CC3; Log_CC4; Log_CC5];
    t = (i - 1) * 0.05;
    
end

% function [SoC, Qloss, SoH, Temp, i, Log_Charging] = nCC(I, SoC, SoCRange, Qloss, SoH, Temp, i)
function [SoC, Qloss, SoH, Temp, i] = nCC(I, SoC, SoCRange, Qloss, SoH, Temp, i)
% Battery n-Constant Current Charging Process
% Input: 
%   I: Battery current(Charging positive)
%   SoC: State of Charge
%   SoCRange: n-CC Charging SoC Range
%   Qloss: Loss battery capacity
%   SoH: State of Health
%   Temp: Battery temperature
%   i: Flag of cycle
% Output:
%   SoC: State of Charge
%   Qloss: Loss battery capacity
%   SoH: State of Health
%   Temp: Battery temperature
%   i: Flag of cycle
%   Log_Charging: Save charging process data

    while SoC <= SoCRange
        
        if I == 0
            break
        end
        
        % [Vt, SoC] = ECM(I, Temp, SoC);
        [~, SoC] = ECM(I, Temp, SoC);
        Temp = ThM(I, Temp, SoC);
        [Qloss, SoH] = AM(I, Temp, Qloss);
        
%         % record
%         Log_Charging = zeros(20000,7); % Preallocated memory
%         Log_Charging(i, 1) = (i - 1) * 0.05;
%         Log_Charging(i, 2) = Vt;
%         Log_Charging(i, 3) = I;
%         Log_Charging(i, 4) = SoC;
%         Log_Charging(i, 5) = Qloss;
%         Log_Charging(i, 6) = SoH;
%         Log_Charging(i, 7) = Temp;
        i = i + 1;
    end
end
